<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>wums</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="wums note">
    <link rel="preload" href="/source-files/assets/css/0.styles.6eaab90e.css" as="style"><link rel="preload" href="/source-files/assets/js/app.f05af674.js" as="script"><link rel="preload" href="/source-files/assets/js/2.98231419.js" as="script"><link rel="preload" href="/source-files/assets/js/67.a72b2d5d.js" as="script"><link rel="prefetch" href="/source-files/assets/js/10.a9e7c10e.js"><link rel="prefetch" href="/source-files/assets/js/11.d1383481.js"><link rel="prefetch" href="/source-files/assets/js/12.88a800cc.js"><link rel="prefetch" href="/source-files/assets/js/13.d2277c3f.js"><link rel="prefetch" href="/source-files/assets/js/14.9bd4931d.js"><link rel="prefetch" href="/source-files/assets/js/15.9c6fd0cd.js"><link rel="prefetch" href="/source-files/assets/js/16.082c926d.js"><link rel="prefetch" href="/source-files/assets/js/17.3219be0c.js"><link rel="prefetch" href="/source-files/assets/js/18.b33c8793.js"><link rel="prefetch" href="/source-files/assets/js/19.2820d4d6.js"><link rel="prefetch" href="/source-files/assets/js/20.4169672d.js"><link rel="prefetch" href="/source-files/assets/js/21.43ecc853.js"><link rel="prefetch" href="/source-files/assets/js/22.d8195a62.js"><link rel="prefetch" href="/source-files/assets/js/23.f0d571bf.js"><link rel="prefetch" href="/source-files/assets/js/24.cd3533db.js"><link rel="prefetch" href="/source-files/assets/js/25.2c0c6e9d.js"><link rel="prefetch" href="/source-files/assets/js/26.56f43f39.js"><link rel="prefetch" href="/source-files/assets/js/27.368913d4.js"><link rel="prefetch" href="/source-files/assets/js/28.2a31ffca.js"><link rel="prefetch" href="/source-files/assets/js/29.96527dd1.js"><link rel="prefetch" href="/source-files/assets/js/3.a33f8bbb.js"><link rel="prefetch" href="/source-files/assets/js/30.53e34301.js"><link rel="prefetch" href="/source-files/assets/js/31.51f39588.js"><link rel="prefetch" href="/source-files/assets/js/32.b65f7e2c.js"><link rel="prefetch" href="/source-files/assets/js/33.9e0bec38.js"><link rel="prefetch" href="/source-files/assets/js/34.f1e2df77.js"><link rel="prefetch" href="/source-files/assets/js/35.3cd08acc.js"><link rel="prefetch" href="/source-files/assets/js/36.7d96950e.js"><link rel="prefetch" href="/source-files/assets/js/37.b66e50c2.js"><link rel="prefetch" href="/source-files/assets/js/38.398f5ba1.js"><link rel="prefetch" href="/source-files/assets/js/39.4f29a3f0.js"><link rel="prefetch" href="/source-files/assets/js/4.2a0bc255.js"><link rel="prefetch" href="/source-files/assets/js/40.4e667bdb.js"><link rel="prefetch" href="/source-files/assets/js/41.147ece2a.js"><link rel="prefetch" href="/source-files/assets/js/42.d5fa019e.js"><link rel="prefetch" href="/source-files/assets/js/43.570c1431.js"><link rel="prefetch" href="/source-files/assets/js/44.d89157ff.js"><link rel="prefetch" href="/source-files/assets/js/45.0d96ee49.js"><link rel="prefetch" href="/source-files/assets/js/46.aa9cc8a2.js"><link rel="prefetch" href="/source-files/assets/js/47.8977f1aa.js"><link rel="prefetch" href="/source-files/assets/js/48.b448eb15.js"><link rel="prefetch" href="/source-files/assets/js/49.7ad0798f.js"><link rel="prefetch" href="/source-files/assets/js/5.8650ae61.js"><link rel="prefetch" href="/source-files/assets/js/50.ce92c6a3.js"><link rel="prefetch" href="/source-files/assets/js/51.b2347a5b.js"><link rel="prefetch" href="/source-files/assets/js/52.1f4f2908.js"><link rel="prefetch" href="/source-files/assets/js/53.5d95a3c7.js"><link rel="prefetch" href="/source-files/assets/js/54.fcc0a2f3.js"><link rel="prefetch" href="/source-files/assets/js/55.c46fb1e3.js"><link rel="prefetch" href="/source-files/assets/js/56.b8a40418.js"><link rel="prefetch" href="/source-files/assets/js/57.c4659184.js"><link rel="prefetch" href="/source-files/assets/js/58.8cae2ea4.js"><link rel="prefetch" href="/source-files/assets/js/59.2c4fde8e.js"><link rel="prefetch" href="/source-files/assets/js/6.10edd4c9.js"><link rel="prefetch" href="/source-files/assets/js/60.1498e5b8.js"><link rel="prefetch" href="/source-files/assets/js/61.35f67ca4.js"><link rel="prefetch" href="/source-files/assets/js/62.9f0b4443.js"><link rel="prefetch" href="/source-files/assets/js/63.0c2d410a.js"><link rel="prefetch" href="/source-files/assets/js/64.d26df2b9.js"><link rel="prefetch" href="/source-files/assets/js/65.2b3dbb52.js"><link rel="prefetch" href="/source-files/assets/js/66.a87c141b.js"><link rel="prefetch" href="/source-files/assets/js/68.7c8754b5.js"><link rel="prefetch" href="/source-files/assets/js/69.c72140c2.js"><link rel="prefetch" href="/source-files/assets/js/7.d1dcdd07.js"><link rel="prefetch" href="/source-files/assets/js/70.2eda0f30.js"><link rel="prefetch" href="/source-files/assets/js/71.6cd5ea24.js"><link rel="prefetch" href="/source-files/assets/js/72.82fa4cdd.js"><link rel="prefetch" href="/source-files/assets/js/73.f0bd258c.js"><link rel="prefetch" href="/source-files/assets/js/74.9f798f5a.js"><link rel="prefetch" href="/source-files/assets/js/75.b29f1493.js"><link rel="prefetch" href="/source-files/assets/js/76.88645ca2.js"><link rel="prefetch" href="/source-files/assets/js/77.d167c6eb.js"><link rel="prefetch" href="/source-files/assets/js/78.c2c289aa.js"><link rel="prefetch" href="/source-files/assets/js/79.5ee04c40.js"><link rel="prefetch" href="/source-files/assets/js/8.0f059b82.js"><link rel="prefetch" href="/source-files/assets/js/80.8bd84745.js"><link rel="prefetch" href="/source-files/assets/js/81.042e3aa4.js"><link rel="prefetch" href="/source-files/assets/js/82.10af573e.js"><link rel="prefetch" href="/source-files/assets/js/83.ff534d9a.js"><link rel="prefetch" href="/source-files/assets/js/84.9e64e38b.js"><link rel="prefetch" href="/source-files/assets/js/85.c3a40081.js"><link rel="prefetch" href="/source-files/assets/js/9.6db4de5e.js">
    <link rel="stylesheet" href="/source-files/assets/css/0.styles.6eaab90e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/source-files/" class="home-link router-link-active"><!----> <span class="site-name">wums</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/source-files/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://gitee.com/wmsnote/dashboard/wikis" target="_blank" rel="noopener noreferrer" class="nav-link external">
  WiKi
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://gitee.com/wmsnote/source-files" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitEE
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/source-files/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://gitee.com/wmsnote/dashboard/wikis" target="_blank" rel="noopener noreferrer" class="nav-link external">
  WiKi
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://gitee.com/wmsnote/source-files" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitEE
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/shell/" class="sidebar-heading clickable open"><span>shell</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/source-files/shell/Bash简介.html" class="sidebar-link">Bash简介</a></li><li><a href="/source-files/shell/基本语法.html" class="sidebar-link">基本语法</a></li><li><a href="/source-files/shell/Bash的模式扩展.html" class="sidebar-link">Bash的模式扩展</a></li><li><a href="/source-files/shell/引号和转义.html" class="sidebar-link">引号和转义</a></li><li><a href="/source-files/shell/变量.html" class="sidebar-link">变量</a></li><li><a href="/source-files/shell/字符串操作.html" class="sidebar-link">字符串操作</a></li><li><a href="/source-files/shell/算数运算.html" class="sidebar-link">算数运算</a></li><li><a href="/source-files/shell/Bash行操作.html" class="sidebar-link">Bash行操作</a></li><li><a href="/source-files/shell/目录堆栈.html" class="sidebar-link">目录堆栈</a></li><li><a href="/source-files/shell/Bash脚本入门.html" class="sidebar-link">Bash脚本入门</a></li><li><a href="/source-files/shell/read命令.html" class="sidebar-link">read命令</a></li><li><a href="/source-files/shell/条件判断.html" class="sidebar-link">条件判断</a></li><li><a href="/source-files/shell/循环.html" class="sidebar-link">循环</a></li><li><a href="/source-files/shell/函数.html" class="sidebar-link">函数</a></li><li><a href="/source-files/shell/数组.html" class="sidebar-link">数组</a></li><li><a href="/source-files/shell/set.html" class="sidebar-link">set命令</a></li><li><a href="/source-files/shell/脚本除错.html" class="sidebar-link">脚本除错</a></li><li><a href="/source-files/shell/mktemp_and_trap.html" class="sidebar-link">mktemp命令和trap命令</a></li><li><a href="/source-files/shell/Bash启动环境.html" class="sidebar-link">Bash启动环境</a></li><li><a href="/source-files/shell/命令提示符.html" class="sidebar-link">命令提示符</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/设计模式/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/prometheus/" class="sidebar-heading clickable"><span>prometheus</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/travis-ci/" class="sidebar-heading clickable"><span>travis-ci教程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/Dockerfile/" class="sidebar-heading clickable"><span>Dockerfile</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/java/" class="sidebar-heading clickable"><span>Java教程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/springboot2/" class="sidebar-heading clickable router-link-active"><span>SpringBoot2.x</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source-files/nginx/" class="sidebar-heading clickable"><span>nginx</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>基于Spring Boot 2.2.6实现Rest风格的文件上传&amp;下载APIs</p> <p>Spring Boot 2.0 Restful Style MultipartFile Upload and Download APIs</p> <p>文件上传与下载在Web应用中是一个比较常见的功能。在本教程中，我将基于Spring 2.2.6版本实现一个基于Restful风格的文件上传与下载APIs。</p> <p>基于Spring Boot 2.0实战系列源码已经Push到Github仓库：<a href="https://github.com/ramostear/springboot2.0-action" target="_blank" rel="noopener noreferrer">Github仓库地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
感兴趣的朋友欢迎Star/Fork。</p> <h2 id="_1-environment"><a href="#_1-environment" class="header-anchor">#</a> 1. ENVIRONMENT</h2> <ul><li>JDK: Java 1.8</li> <li>Framework: Spring Boot 2.2.6(Only Using Spring Web MVC)</li> <li>Maven: Maven 3.5.0+</li> <li>IDE: IntelliJ IDEA 2019.2</li> <li>Test: Postman 7.23.0</li></ul> <h2 id="_2-function"><a href="#_2-function" class="header-anchor">#</a> 2. FUNCTION</h2> <p>本教程中，使用Spring 2.2.6实现Restful风格的APIs并提供以下的功能：</p> <ol><li>客户端上传文件到服务端</li> <li>对客户端上传文件大小进行限制（50MB）</li> <li>点击链接地址下载文件</li> <li>获得已上传文件列表（文件名和下载地址）</li></ol> <p>下面是教程所实现的APIs列表（服务端请求端口默认8080）：</p> <table><thead><tr><th>请求方式</th> <th>URL地址</th> <th>说明</th></tr></thead> <tbody><tr><td>POST</td> <td>/upload</td> <td>上传一份文件</td></tr> <tr><td>GET</td> <td>/files</td> <td>获取已上传的文件列表</td></tr> <tr><td>GET</td> <td>/files/{fileName}</td> <td>根据文件地址下载文件</td></tr></tbody></table> <h2 id="_3-project-architecture"><a href="#_3-project-architecture" class="header-anchor">#</a> 3. PROJECT ARCHITECTURE</h2> <p>工程目录结构说明如下：</p> <ol><li>config/FileUploadConfiguration.java: 常规组件，主要在重启应用时清理历史文件；</li> <li>controller/FileUploadController.java: 主要的控制器，负责处理文件的上传，下载，浏览等请求；</li> <li>exception/FileUploadExceptionAdvice.java: 全局的异常处理类，提供用户友好的异常提示信息；</li> <li>service/FileStorageService.java: 文件上传接口类，提供存储地址初始化，保存文件，加载文件，清理文件等操作；</li> <li>service/impl/FileStorageServiceImpl.java: 文件上传接口实现类；</li> <li>valueobject/UploadFile.java: 封装了文件名和存储地址的POJO类；</li> <li>valueobject/Message.java: 请求/响应的消息对象；</li> <li>resources/application.yml: 项目配置文件，主要配置了文件上传大小限制；</li> <li>pom.xml:Maven依赖配置文件。</li></ol> <h2 id="_4-quick-start"><a href="#_4-quick-start" class="header-anchor">#</a> 4. QUICK START</h2> <p>本教程是基于IntelliJ IDEA创建Spring Boot项目的，你也可以选择自己喜欢的IDE创建项目。创建完项目后，请检查pom.xml文件中是否包含如下配置：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>本教程只使用到Spring Web MVC的功能，因此只需添加spring-boot-starter-web依赖。</p> <h3 id="_4-1-文件上传接口"><a href="#_4-1-文件上传接口" class="header-anchor">#</a> 4.1 文件上传接口</h3> <p>按照面向接口编程的约定(规范)，创建一个用于操作上传文件的接口类FileStorageService.java，并提供相应的方法。</p> <p>service/FileStorageService.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ramostear<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>uploadfile<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart</span><span class="token punctuation">.</span><span class="token class-name">MultipartFile</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file</span><span class="token punctuation">.</span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream</span><span class="token punctuation">.</span><span class="token class-name">Stream</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @ClassName FileStorageService
 * @Description TODO
 * @Author 树下魅狐
 * @Date 2020/4/28 0028 18:35
 * @Version since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FileStorageService</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> multipartFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Resource</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在启动应用时，先调用clear()方法清理历史文件，再调用init()方法初始化文件上传地址。</p> <h3 id="_4-2-实现文件上传接口"><a href="#_4-2-实现文件上传接口" class="header-anchor">#</a> 4.2 实现文件上传接口</h3> <p>文件上传接口实现类比较简单，这里直接给出代码：</p> <p>service/impl/FileStorageServiceImpl.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @ClassName FileStorageServiceImpl
 * @Description TODO
 * @Author 树下魅狐
 * @Date 2020/4/28 0028 18:38
 * @Version since 1.0
 **/</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;fileStorageService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileStorageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">FileStorageService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;fileStorage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">createDirectory</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not initialize folder for upload!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> multipartFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not store the file. Error:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Resource</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Path</span> file <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlResource</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">toUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> resource<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> resource<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not read the file.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Error:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>path <span class="token operator">-&gt;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token operator">::</span><span class="token function">relativize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not load the files.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FileSystemUtils</span><span class="token punctuation">.</span><span class="token function">deleteRecursively</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>其中，Files、Path和Paths是java.nio.file提供的类，Resource是org.springframework.core.io包中提供的类。</p> <h3 id="_4-3-定义值对象"><a href="#_4-3-定义值对象" class="header-anchor">#</a> 4.3 定义值对象</h3> <p>本教程中，定义了两个简单的对象UploadFile.java和Message.java，分别封装了上传文件信息和响应消息，代码如下：</p> <p>valueobject/UploadFile.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @ClassName UploadFile
 * @Description TODO
 * @Author 树下魅狐
 * @Date 2020/4/28 0028 18:48
 * @Version since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFile</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fileName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UploadFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fileName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFileName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>valueobject/Message.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @ClassName Message
 * @Description TODO
 * @Author 树下魅狐
 * @Date 2020/4/28 0028 19:21
 * @Version since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_4-4-控制器"><a href="#_4-4-控制器" class="header-anchor">#</a> 4.4 控制器</h3> <p>在controller包下创建文件上传控制器，用于处理客户端的请求。代码如下：</p> <p>controller/FileUploadController.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @ClassName FileUploadController
 * @Description TODO
 * @Author 树下魅狐
 * @Date 2020/4/28 0028 18:52
 * @Version since 1.0
 **/</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploadController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">FileStorageService</span> fileStorageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            fileStorageService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;Upload file successfully: &quot;</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">badRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;Could not upload the file:&quot;</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/files&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">UploadFile</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UploadFile</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>path <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">MvcUriComponentsBuilder</span>
                            <span class="token punctuation">.</span><span class="token function">fromMethodName</span><span class="token punctuation">(</span><span class="token class-name">FileUploadController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;getFile&quot;</span><span class="token punctuation">,</span>
                                    path<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UploadFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/files/{filename:.+}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Resource</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Resource</span> file <span class="token operator">=</span> fileStorageService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>CONTENT_DISPOSITION<span class="token punctuation">,</span>
                        <span class="token string">&quot;attachment;filename=\&quot;&quot;</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>在控制器中，使用@RestController组合注解替换了@Controller+@ResponseBody的注解方式，并采用@RequestMapping的快捷方式注解方法。</p> <h3 id="_4-5配置上传文件大小"><a href="#_4-5配置上传文件大小" class="header-anchor">#</a> 4.5配置上传文件大小</h3> <p>通常，出于安全和性能考虑，我们需要限定客户端上传文件的大小，本教程限定的文件大小最大为50MB。</p> <p>在application.yml(application.properties)文件中添加如下配置：</p> <p>application.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">multipart</span><span class="token punctuation">:</span>
      <span class="token key atrule">max-request-size</span><span class="token punctuation">:</span> 50MB
      <span class="token key atrule">max-file-size</span><span class="token punctuation">:</span> 50MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>application.properties</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">spring.servlet.multipart.max-request-size</span><span class="token punctuation">=</span><span class="token attr-value">50MB</span>
<span class="token attr-name">spring.servlet.multipart.max-file-size</span><span class="token punctuation">=</span><span class="token attr-value">50MB</span>
<span class="token attr-name">spring.servlet.multipart.max-request-size</span><span class="token punctuation">=</span><span class="token attr-value">50MB</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>单次请求所能上传文件的总文件大小spring.servlet.multipart.max-file-size=50MB：单个文件所能上传的文件大小</p> <h3 id="_4-6-全局异常处理"><a href="#_4-6-全局异常处理" class="header-anchor">#</a> 4.6 全局异常处理</h3> <p>在控制器中，文件上传过程中可能产生的异常我们使用try-catch语句进行了用户友好处理，但当客户端上传文件大小超过50MB时，应用会抛出MaxUploadSizeExceededException异常信息，我们需要对此异常信息做处理。最简单的方式是使用@ControllerAdvice+@ExceptionHandler组合方式处理异常。在exception包下创建异常处理类，代码如下：</p> <p>exception/FileUploadExceptionAdvice.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @ClassName FileUploadExceptionAdvice
 * @Description TODO
 * @Author 树下魅狐
 * @Date 2020/4/28 0028 19:10
 * @Version since 1.0
 **/</span>
<span class="token annotation punctuation">@ControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploadExceptionAdvice</span> <span class="token keyword">extends</span> <span class="token class-name">ResponseEntityExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">MaxUploadSizeExceededException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleMaxUploadSizeExceededException</span><span class="token punctuation">(</span><span class="token class-name">MaxUploadSizeExceededException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">badRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;Upload file too large.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_4-7-初始化文件存储空间"><a href="#_4-7-初始化文件存储空间" class="header-anchor">#</a> 4.7 初始化文件存储空间</h3> <p>为了在测试时获得干净的测试数据，同时也为了在应用启动后分配好上传文件存储地址，我们需要在config包下创建一个配置类，在应用启动时调用FileStorageService中的clear()方法和init()方法。实现该功能，最快的方式是配置类实现CommandLineRunner接口类的run()方法，代码如下：</p> <p>config/FileUploadConfiguration.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploadConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">FileStorageService</span> fileStorageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        fileStorageService<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileStorageService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用<code>@Autowired</code>注解将<code>FileStorageService</code>注入到<code>FileUploadConfiguration.java</code>中。</p> <h2 id="_5-run-test"><a href="#_5-run-test" class="header-anchor">#</a> 5. RUN&amp;TEST</h2> <p>运行Spring Boot应用程序的方式有很多，例如：</p> <ol><li>命令方式：mvn spring-boot:run</li> <li>IntelliJ IDEA：点击IntelliJ IDEA的“Run”按钮</li> <li>main()方法：直接运行主类中的main()方法</li> <li>运行jar包：java -jar springboot-fileupload.jar</li></ol> <p>选择一种你比较熟悉的方式运行Spring Boot应用程序。</p> <p>当应用程序启动成功后，该项目的根目录会创建一个名为fileStorage的文件夹，该文件夹将用于存放客户端上传的文件。</p> <blockquote><p>Github仓库地址: https://github.com/ramostear/springboot2.0-action</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/4/2020, 3:17:57 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/source-files/assets/js/app.f05af674.js" defer></script><script src="/source-files/assets/js/2.98231419.js" defer></script><script src="/source-files/assets/js/67.a72b2d5d.js" defer></script>
  </body>
</html>
